generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  HR
}

enum PositionStatus {
  ACTIVE
  PAUSED
  CLOSED
}

enum InterviewStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  EXPIRED
}

enum HRDecision {
  PENDING
  PASSED
  REJECTED
  HOLD
}

enum Recommendation {
  RECOMMENDED
  CAUTIOUS
  NOT_RECOMMENDED
}

model User {
  id        String              @id @default(cuid())
  email     String              @unique
  password  String
  name      String
  role      UserRole            @default(HR)
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
  positions Position[]
  templates InterviewTemplate[] // 用户创建的自定义模板

  // 简历管理关联
  resumes      Resume[]     @relation("ResumeCreatedBy")
  resumeNotes  ResumeNote[] @relation("ResumeNoteCreatedBy")
  resumeLogs   ResumeLog[]  @relation("ResumeLogOperator")
}

model InterviewTemplate {
  id                String     @id @default(cuid())
  name              String     @unique
  description       String?
  minQuestions      Int        @default(5)  // 最少问题数（确保覆盖所有维度）
  maxQuestions      Int        @default(10) // 最多问题数
  dimensions        Json       @default("[\"专业能力\", \"沟通表达\", \"逻辑思维\", \"执行力\", \"职业动机\"]")
  questionTemplates Json?      // 每个维度的示例问题模板
  systemPrompt      String     @db.Text
  isSystem          Boolean    @default(false)  // 是否系统模板
  isActive          Boolean    @default(true)   // 是否可用
  createdById       String?                     // 创建者ID（自定义模板）
  createdBy         User?      @relation(fields: [createdById], references: [id])
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  positions         Position[]
}

model Position {
  id          String            @id @default(cuid())
  name        String
  description String?
  status      PositionStatus    @default(ACTIVE)
  templateId  String
  template    InterviewTemplate @relation(fields: [templateId], references: [id])
  createdById String
  createdBy   User              @relation(fields: [createdById], references: [id])
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  interviews  Interview[]
  resumes     Resume[]          // 岗位关联的简历
}

model Interview {
  id             String          @id @default(cuid())
  token          String          @unique
  candidateName  String
  candidateEmail String?
  candidatePhone String?
  positionId     String
  position       Position        @relation(fields: [positionId], references: [id])
  status         InterviewStatus @default(PENDING)
  currentRound   Int             @default(0)
  minRounds      Int             @default(5)  // 最少问题数
  maxRounds      Int             @default(10) // 最多问题数
  startedAt      DateTime?
  completedAt    DateTime?
  hrDecision     HRDecision?
  hrComment      String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  rounds         InterviewRound[]
  report         InterviewReport?

  // 简历关联（可选，从简历生成的面试链接会有此关联）
  resumeId       String?
  resume         Resume?         @relation(fields: [resumeId], references: [id])
}

model InterviewRound {
  id               String    @id @default(cuid())
  interviewId      String
  interview        Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)
  roundNumber      Int
  dimension        String
  questionText     String    @db.Text
  questionAudioUrl String?
  answerText       String?   @db.Text
  answerAudioUrl   String?
  score            Float?
  evaluation       String?   @db.Text
  durationSeconds  Int?
  createdAt        DateTime  @default(now())

  @@unique([interviewId, roundNumber])
}

model InterviewReport {
  id              String         @id @default(cuid())
  interviewId     String         @unique
  interview       Interview      @relation(fields: [interviewId], references: [id], onDelete: Cascade)
  dimensionScores Json
  strengths       Json
  risks           Json
  recommendation  Recommendation
  summary         String         @db.Text
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
}

// ============================================
// 简历管理相关模型
// ============================================

enum ParseStatus {
  PENDING
  PARSING
  SUCCESS
  FAILED
}

model Resume {
  id             String      @id @default(cuid())

  // 文件信息
  fileName       String      // 原始文件名
  fileKey        String      // MinIO 存储 key
  fileSize       Int         // 文件大小（字节）
  mimeType       String      // 文件类型

  // AI 解析字段
  candidateName  String?     // 候选人姓名
  phone          String?     // 手机号
  email          String?     // 邮箱
  education      String?     // 学历
  school         String?     // 毕业院校
  major          String?     // 专业
  workYears      Int?        // 工作年限
  expectedSalary String?     // 期望薪资
  skills         Json?       // 技能标签 ["Java", "Python"]
  rawText        String?     @db.Text // 简历原文
  parseStatus    ParseStatus @default(PENDING)
  parseError     String?     // 解析失败原因

  // 关联
  positionId     String
  position       Position    @relation(fields: [positionId], references: [id])
  createdById    String
  createdBy      User        @relation("ResumeCreatedBy", fields: [createdById], references: [id])

  interviews     Interview[]
  notes          ResumeNote[]
  logs           ResumeLog[]

  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
}

model ResumeNote {
  id          String   @id @default(cuid())
  content     String   @db.Text

  resumeId    String
  resume      Resume   @relation(fields: [resumeId], references: [id], onDelete: Cascade)
  createdById String
  createdBy   User     @relation("ResumeNoteCreatedBy", fields: [createdById], references: [id])

  createdAt   DateTime @default(now())
}

model ResumeLog {
  id         String   @id @default(cuid())
  action     String   // UPLOAD/DELETE/ADD_NOTE/EDIT_INFO/...
  details    Json?    // 操作详情

  resumeId   String?  // 删除后可能为空
  resume     Resume?  @relation(fields: [resumeId], references: [id], onDelete: SetNull)
  operatorId String
  operator   User     @relation("ResumeLogOperator", fields: [operatorId], references: [id])

  createdAt  DateTime @default(now())
}
