# AI 语音面试系统 - 需求变更设计文档 v1.1

## 1. 变更概述

### 1.1 变更背景

基于 MVP 版本的使用反馈，需要对系统进行以下优化：

1. **岗位问题模板可编辑**：HR 需要能够自定义每个岗位的面试问题模板
2. **候选人界面优化**：面试时不显示问题文字，仅播放语音，更接近真实面试场景
3. **AI 问题风格优化**：问题内容模拟真实面试官问法，去除元信息提示

### 1.2 变更范围

| 模块 | 变更类型 | 影响程度 |
|------|----------|----------|
| 数据模型 | 新增字段 | 中 |
| HR 后台 | 新增页面 | 高 |
| 候选人界面 | UI 调整 | 低 |
| AI Prompt | 重构 | 中 |

---

## 2. 需求详细设计

### 2.1 岗位问题模板系统

#### 2.1.1 功能描述

- 每个岗位关联一套可编辑的面试问题模板
- HR 可以查看、修改模板中的示例问题
- AI 生成问题时参考模板，但不完全照搬（保持灵活性）

#### 2.1.2 模板数据结构

```typescript
interface QuestionTemplate {
  id: string
  dimension: string           // 评估维度
  sampleQuestions: string[]   // 示例问题列表（HR 可编辑）
  guidance: string            // AI 生成指导（可选）
}

interface PositionTemplate {
  positionId: string
  questions: QuestionTemplate[]
}
```

#### 2.1.3 数据库模型变更

**修改 `InterviewTemplate` 表，新增 `questionTemplates` 字段：**

```prisma
model InterviewTemplate {
  id               String     @id @default(cuid())
  name             String     @unique
  description      String?
  questionCount    Int        @default(5)
  dimensions       Json       // 评估维度列表
  questionTemplates Json      // 新增：每个维度的示例问题模板
  systemPrompt     String     @db.Text
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  positions        Position[]
}
```

**`questionTemplates` JSON 结构示例：**

```json
[
  {
    "dimension": "专业能力",
    "sampleQuestions": [
      "能介绍一下你最近负责的一个项目吗？",
      "在这个项目中你遇到的最大挑战是什么？你是怎么解决的？",
      "你通常是如何进行项目风险管理的？"
    ],
    "guidance": "围绕候选人的项目经验深入追问"
  },
  {
    "dimension": "沟通表达",
    "sampleQuestions": [
      "能举个例子说明你是如何与团队成员沟通协作的？",
      "当团队成员对你的方案有不同意见时，你会怎么处理？"
    ],
    "guidance": "观察候选人的表达清晰度和逻辑性"
  }
]
```

#### 2.1.4 HR 后台 - 模板编辑界面

**新增页面：** `/dashboard/templates/[id]/edit`

**功能要点：**

1. 显示当前模板的所有评估维度
2. 每个维度下展示示例问题列表（可增删改）
3. 支持拖拽排序问题顺序
4. 提供"恢复默认"按钮
5. 保存时校验：每个维度至少 1 个示例问题

**UI 原型：**

```
┌─────────────────────────────────────────────────────┐
│  编辑面试模板：项目经理                    [保存] [取消] │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ▼ 专业能力                              [+ 添加问题] │
│  ┌─────────────────────────────────────────────┐   │
│  │ 1. 能介绍一下你最近负责的一个项目吗？    [编辑][删除] │
│  │ 2. 在这个项目中你遇到的最大挑战是什么？  [编辑][删除] │
│  │ 3. 你通常是如何进行项目风险管理的？      [编辑][删除] │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  ▼ 沟通表达                              [+ 添加问题] │
│  ┌─────────────────────────────────────────────┐   │
│  │ 1. 能举个例子说明你是如何与团队沟通的？  [编辑][删除] │
│  │ 2. 当团队成员有不同意见时，你怎么处理？  [编辑][删除] │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  ▼ 逻辑思维 ...                                     │
│  ▼ 执行力 ...                                       │
│  ▼ 职业动机 ...                                     │
└─────────────────────────────────────────────────────┘
```

#### 2.1.5 API 变更

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | `/api/templates/:id` | 获取模板详情（含问题模板） |
| PUT | `/api/templates/:id/questions` | 更新问题模板 |
| POST | `/api/templates/:id/reset` | 重置为默认问题模板 |

---

### 2.2 候选人面试界面优化

#### 2.2.1 变更内容

**当前实现（需移除）：**
- 面试界面显示问题文字：`<p>{state.currentQuestion.questionText}</p>`
- 显示评估维度标签：`{state.currentQuestion.dimension}`

**目标实现：**
- 仅播放语音，不显示问题文字
- 不显示评估维度信息
- 保留"重新播放"按钮（用于听不清时）

#### 2.2.2 UI 变更对比

**变更前：**
```
┌─────────────────────────────────────────┐
│  第 1 题                      [专业能力] │
├─────────────────────────────────────────┤
│                                         │
│  能介绍一下你最近负责的一个项目吗？       │
│                                         │
│  [🔊 重新播放]                           │
└─────────────────────────────────────────┘
```

**变更后：**
```
┌─────────────────────────────────────────┐
│  第 1 题                                │
├─────────────────────────────────────────┤
│                                         │
│         🎧 正在播放问题...               │
│                                         │
│  [🔊 重新播放]                           │
└─────────────────────────────────────────┘
```

#### 2.2.3 代码变更位置

**文件：** `src/app/interview/[token]/page.tsx`

**变更点：**
1. 移除第 267 行的维度显示
2. 移除第 272 行的问题文字显示
3. 添加音频播放状态指示器

---

### 2.3 AI 问题生成风格优化

#### 2.3.1 问题风格对比

**当前风格（需优化）：**
```
这是面试问题，我将重点评估您的专业能力。
请介绍一下您最近负责的一个项目，包括项目背景、您的角色和主要成果。
```

**目标风格（自然问法）：**
```
你好，先简单介绍一下自己吧，包括你的工作经历和擅长的领域。
```

```
刚才你提到了那个电商项目，能具体说说你在里面负责什么吗？遇到过什么困难？
```

```
如果让你重新做一次这个项目，有什么地方你会做得不一样？
```

#### 2.3.2 Prompt 重构

**文件：** `src/lib/ai/prompts/interviewer.ts`

**新的 System Prompt：**

```typescript
export const INTERVIEWER_SYSTEM_PROMPT = `你是一位经验丰富的面试官，正在进行一场真实的面试对话。

## 核心原则

1. **自然对话**：像真人面试官一样提问，语气亲切专业
2. **禁止元信息**：绝对不要提及"评估维度"、"面试问题"、"考察点"等词汇
3. **追问深入**：根据候选人回答自然追问，而非机械切换话题
4. **简洁明了**：问题简短有力，一次只问一个问题

## 问题风格示例

✅ 正确示例：
- "你好，先简单介绍一下自己吧。"
- "刚才你提到的那个项目，能具体说说你负责哪部分吗？"
- "遇到这种情况你一般会怎么处理？"
- "如果重新来一次，你会有什么不同的做法？"

❌ 错误示例：
- "这是关于专业能力的问题..."
- "我想评估一下你的沟通能力..."
- "请回答以下面试问题..."
- "本题考察的是..."

## 输出要求

直接输出问题，不要有任何前缀、后缀或解释。`
```

#### 2.3.3 问题生成逻辑变更

**文件：** `src/lib/ai/llm.ts` - `generateQuestion` 函数

**变更前：**
```typescript
let prompt = `岗位：${positionName}\n当前评估维度：${dimension}\n\n`
// ...
prompt += '请生成一个针对该维度的面试问题。'
```

**变更后：**
```typescript
let prompt = `你正在面试一位应聘「${positionName}」岗位的候选人。\n\n`

// 注入示例问题作为参考
if (questionTemplates && questionTemplates.length > 0) {
  prompt += '参考问题风格（不要照搬，根据对话自然提问）：\n'
  questionTemplates.forEach(q => prompt += `- ${q}\n`)
  prompt += '\n'
}

if (previousQA.length > 0) {
  prompt += '对话历史：\n'
  previousQA.forEach((qa, i) => {
    prompt += `你：${qa.question}\n候选人：${qa.answer}\n\n`
  })
}

if (previousQA.length === 0) {
  prompt += '这是面试开始，请自然地开场并提出第一个问题。'
} else {
  prompt += '请根据候选人的回答，自然地继续对话或追问。'
}
```

---

## 3. 实施计划

### 3.1 开发任务分解

| 序号 | 任务 | 优先级 | 依赖 |
|------|------|--------|------|
| 1 | 数据库迁移：新增 `questionTemplates` 字段 | P0 | - |
| 2 | 更新种子数据：添加默认问题模板 | P0 | 1 |
| 3 | API：模板查询/更新接口 | P0 | 1 |
| 4 | HR 后台：模板编辑页面 | P1 | 3 |
| 5 | AI Prompt 重构 | P0 | - |
| 6 | 问题生成逻辑：集成模板参考 | P0 | 1, 5 |
| 7 | 候选人界面：隐藏问题文字 | P0 | - |
| 8 | 测试与验证 | P0 | 全部 |

### 3.2 文件变更清单

```
prisma/
├── schema.prisma              # 修改：新增 questionTemplates 字段
└── seed.ts                    # 修改：添加默认问题模板数据

src/
├── app/
│   ├── api/templates/
│   │   └── [id]/
│   │       ├── route.ts       # 新增：获取模板详情
│   │       ├── questions/
│   │       │   └── route.ts   # 新增：更新问题模板
│   │       └── reset/
│   │           └── route.ts   # 新增：重置模板
│   ├── dashboard/
│   │   └── templates/
│   │       └── [id]/
│   │           └── edit/
│   │               └── page.tsx  # 新增：模板编辑页面
│   └── interview/
│       └── [token]/
│           └── page.tsx       # 修改：隐藏问题文字
├── lib/
│   └── ai/
│       ├── prompts/
│       │   └── interviewer.ts # 修改：重构 Prompt
│       └── llm.ts             # 修改：问题生成逻辑
└── components/
    └── templates/
        └── QuestionEditor.tsx # 新增：问题编辑组件
```

---

## 4. 默认问题模板（种子数据）

### 4.1 项目经理岗位

```json
[
  {
    "dimension": "专业能力",
    "sampleQuestions": [
      "先简单介绍一下自己吧，包括你的工作经历。",
      "能说说你最近负责的一个项目吗？",
      "这个项目中你遇到的最大挑战是什么？最后怎么解决的？",
      "你们项目的进度是怎么管控的？"
    ]
  },
  {
    "dimension": "沟通表达",
    "sampleQuestions": [
      "项目中遇到跨部门协作的问题，你一般怎么处理？",
      "能举个例子说说你是怎么向上级汇报项目进展的？",
      "团队成员对方案有不同意见时，你会怎么做？"
    ]
  },
  {
    "dimension": "逻辑思维",
    "sampleQuestions": [
      "如果项目突然要提前上线，你会怎么调整计划？",
      "怎么判断一个需求该不该做？",
      "项目出了问题，你一般怎么定位原因？"
    ]
  },
  {
    "dimension": "执行力",
    "sampleQuestions": [
      "有没有遇到过项目延期的情况？当时怎么处理的？",
      "你是怎么确保团队按时交付的？",
      "资源不够的时候，你会怎么办？"
    ]
  },
  {
    "dimension": "职业动机",
    "sampleQuestions": [
      "为什么想换工作？",
      "你对下一份工作有什么期望？",
      "未来三年有什么职业规划？"
    ]
  }
]
```

### 4.2 产品经理岗位

```json
[
  {
    "dimension": "专业能力",
    "sampleQuestions": [
      "先介绍一下自己吧。",
      "能说说你做过的最有成就感的产品吗？",
      "这个产品的核心指标是什么？效果怎么样？",
      "你是怎么做需求分析的？"
    ]
  },
  {
    "dimension": "沟通表达",
    "sampleQuestions": [
      "开发说需求做不了，你一般怎么沟通？",
      "怎么向老板汇报产品规划？",
      "用户调研你一般怎么做？"
    ]
  },
  {
    "dimension": "逻辑思维",
    "sampleQuestions": [
      "需求太多做不完，你怎么排优先级？",
      "竞品分析你一般关注哪些方面？",
      "数据下降了，你会怎么分析原因？"
    ]
  },
  {
    "dimension": "执行力",
    "sampleQuestions": [
      "产品上线后效果不好，你会怎么办？",
      "怎么推动一个大家都不想做的需求？",
      "版本延期了你会怎么处理？"
    ]
  },
  {
    "dimension": "职业动机",
    "sampleQuestions": [
      "为什么想做产品经理？",
      "你觉得好的产品经理应该具备什么能力？",
      "对我们公司的产品有什么了解？"
    ]
  }
]
```

### 4.3 销售人员岗位

```json
[
  {
    "dimension": "专业能力",
    "sampleQuestions": [
      "先介绍一下你的销售经历吧。",
      "你之前主要卖什么产品？客单价大概多少？",
      "能说说你成交的最大一单吗？",
      "你的销售业绩在团队里排什么水平？"
    ]
  },
  {
    "dimension": "沟通表达",
    "sampleQuestions": [
      "客户说太贵了，你一般怎么回应？",
      "怎么快速和陌生客户建立信任？",
      "客户犹豫不决的时候，你会怎么推进？"
    ]
  },
  {
    "dimension": "逻辑思维",
    "sampleQuestions": [
      "怎么判断一个客户值不值得跟进？",
      "你是怎么规划自己的客户拜访的？",
      "丢单了你一般会怎么复盘？"
    ]
  },
  {
    "dimension": "执行力",
    "sampleQuestions": [
      "月底还差业绩，你会怎么冲刺？",
      "客户一直拖着不签约，你怎么办？",
      "有没有遇到过特别难搞的客户？怎么处理的？"
    ]
  },
  {
    "dimension": "职业动机",
    "sampleQuestions": [
      "为什么选择做销售？",
      "你对收入有什么期望？",
      "能接受出差吗？频率大概多少？"
    ]
  }
]
```

---

## 5. 风险与注意事项

### 5.1 兼容性风险

| 风险点 | 影响 | 应对措施 |
|--------|------|----------|
| 现有面试数据 | 低 | 新字段设为可选，不影响历史数据 |
| 正在进行的面试 | 低 | 变更仅影响新生成的问题 |

### 5.2 用户体验注意事项

1. **语音播放失败兜底**：如果 TTS 失败，需要有文字显示的降级方案
2. **网络延迟**：语音加载需要 loading 状态提示
3. **模板编辑权限**：考虑是否所有 HR 都能编辑模板

---

## 6. 验收标准

### 6.1 功能验收

- [ ] HR 可以查看和编辑岗位的问题模板
- [ ] 编辑后的模板能正确保存和加载
- [ ] AI 生成的问题参考了模板中的示例
- [ ] 候选人面试界面不显示问题文字
- [ ] AI 问题风格自然，无元信息提示

### 6.2 质量验收

- [ ] 所有 API 有错误处理
- [ ] 模板编辑有表单校验
- [ ] 语音播放失败有降级处理
- [ ] 代码通过 lint 检查
- [ ] 关键功能有单元测试
